<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Compressor Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 20px; background: linear-gradient(135deg, #111827, #1f2937); min-height: 100vh; }
        input[type="range"] { width: 100%; height: 6px; border-radius: 5px; background: #374151; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: #3b82f6; cursor: pointer; border: none; }
        .meter { width: 48px; height: 192px; background: #111827; border-radius: 8px; border: 1px solid #374151; position: relative; overflow: hidden; }
        .meter-bar { position: absolute; bottom: 0; width: 100%; transition: height 100ms; }
    </style>
</head>
<body>
    <div class="max-w-6xl mx-auto p-6 bg-gray-900 text-white rounded-lg shadow-2xl">
        <h2 class="text-3xl font-bold mb-6 text-center bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
            Interactive Compressor with Real-Time Animation
        </h2>

        <div class="grid lg:grid-cols-2 gap-6">
            <div class="space-y-4">
                <!-- Compression Curve -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <h3 class="text-lg font-semibold mb-3 text-blue-300">Compression Curve</h3>
                    <svg id="svg" viewBox="0 0 300 300" class="w-full bg-gray-900 rounded"></svg>
                </div>
            </div>

            <div class="space-y-4">
                <!-- Meters and Animation Control -->
                <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-blue-300">Signal Flow</h3>
                        <button id="playBtn" class="px-4 py-2 rounded font-semibold bg-green-600 hover:bg-green-500">▶ Play</button>
                    </div>
                    <div class="flex justify-around items-end">
                        <div class="text-center">
                            <div class="text-xs font-semibold mb-2 text-gray-300">INPUT</div>
                            <div class="meter"><div id="inputBar" class="meter-bar" style="height:33%; background:#22c55e;"></div></div>
                            <div id="inputVal" class="text-xs font-mono mt-2">-40 dB</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-semibold mb-2 text-gray-300">GAIN REDUCTION</div>
                            <div class="meter"><div id="grBar" class="meter-bar" style="height:0%; background:#22c55e;"></div></div>
                            <div id="grVal" class="text-xs font-mono mt-2 text-yellow-400">0.0 dB</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs font-semibold mb-2 text-gray-300">OUTPUT</div>
                            <div class="meter"><div id="outputBar" class="meter-bar" style="height:33%; background:#a855f7;"></div></div>
                            <div id="outputVal" class="text-xs font-mono mt-2">-40 dB</div>
                        </div>
                    </div>
                    <div id="prompt" class="mt-4 text-center text-sm text-gray-400">▲ Press Play to see compression!</div>
                </div>

                <!-- Controls -->
                <!-- Controls -->
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Threshold</label>
                            <span id="threshVal" class="text-sm font-mono text-red-400">-20 dB</span>
                        </div>
                        <input type="range" id="threshold" min="-60" max="0" value="-20">
                    </div>
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Ratio</label>
                            <span id="ratioVal" class="text-sm font-mono text-purple-400">4:1</span>
                        </div>
                        <input type="range" id="ratio" min="1" max="20" value="4" step="0.5">
                    </div>
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Attack</label>
                            <span id="attackVal" class="text-sm font-mono text-orange-400">10 ms</span>
                        </div>
                        <input type="range" id="attack" min="0.1" max="100" value="10" step="0.1">
                    </div>
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Release</label>
                            <span id="releaseVal" class="text-sm font-mono text-cyan-400">100 ms</span>
                        </div>
                        <input type="range" id="release" min="10" max="1000" value="100" step="10">
                    </div>
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Knee</label>
                            <span id="kneeVal" class="text-sm font-mono text-pink-400">Medium</span>
                        </div>
                        <input type="range" id="knee" min="0" max="6" value="3" step="1">
                    </div>
                    <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                        <div class="flex justify-between mb-2">
                            <label class="text-sm font-semibold">Makeup Gain</label>
                            <span id="makeupVal" class="text-sm font-mono text-green-400">+0 dB</span>
                        </div>
                        <input type="range" id="makeupGain" min="0" max="20" value="0" step="0.5">
                    </div>
                </div>
                
                <!-- Presets spanning full width -->
                <div class="bg-gray-800 rounded-lg p-3 border border-gray-700">
                    <div class="text-sm font-semibold mb-2 text-blue-300">Presets</div>
                    <div class="grid grid-cols-5 gap-2">
                        <button onclick="preset('reset')" class="px-2 py-1 bg-blue-600 hover:bg-blue-500 rounded text-xs">Reset</button>
                        <button onclick="preset('vocal')" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Vocal</button>
                        <button onclick="preset('bass')" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Bass</button>
                        <button onclick="preset('snare')" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Snare</button>
                        <button onclick="preset('mixbus')" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 rounded text-xs">Mix Bus</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let s = { threshold:-20, ratio:4, attack:10, release:100, knee:3, makeupGain:0, playing:false, input:-40, output:-40, gr:0, time:0, frame:null };

        function calcOutput(input) {
            let above = input - s.threshold;
            if (above <= 0) return input + s.makeupGain;
            if (above < s.knee) {
                let kr = 1 + ((s.ratio - 1) * (above / s.knee));
                return s.threshold + (above / kr) + s.makeupGain;
            }
            return s.threshold + (above / s.ratio) + s.makeupGain;
        }

        function genSignal(t) {
            let bt = t % 12;
            if (bt < 0.8) return -8;
            if (bt < 3.5) return -8 - ((bt - 0.8) / 2.7) * 22;
            if (bt < 6.5) return -30 + Math.sin(t * 8) * 2;
            if (bt < 7.3) return -12;
            if (bt < 10) return -12 - ((bt - 7.3) / 2.7) * 18;
            return -30 + ((bt - 10) / 2) * 22;
        }

        function h(db) { return Math.max(0, Math.min(100, ((db + 60) / 60) * 100)); }
        function hgr(gr) { return Math.max(0, Math.min(100, (gr / 20) * 100)); }

        function updateMeters() {
            let ih = h(s.input), oh = h(s.output), gh = hgr(s.gr);
            document.getElementById('inputBar').style.height = ih + '%';
            document.getElementById('inputBar').style.background = ih > 83 ? '#ef4444' : ih > 66 ? '#f59e0b' : '#22c55e';
            document.getElementById('inputVal').textContent = Math.round(s.input) + ' dB';
            document.getElementById('outputBar').style.height = oh + '%';
            document.getElementById('outputBar').style.background = oh > 83 ? '#ef4444' : oh > 66 ? '#f59e0b' : '#a855f7';
            document.getElementById('outputVal').textContent = Math.round(s.output) + ' dB';
            document.getElementById('grBar').style.height = gh + '%';
            document.getElementById('grBar').style.background = s.gr > 10 ? '#ef4444' : s.gr > 6 ? '#f59e0b' : s.gr > 3 ? '#eab308' : '#22c55e';
            document.getElementById('grVal').textContent = (s.gr > 0.1 ? '-' + s.gr.toFixed(1) : '0.0') + ' dB';
        }

        function draw() {
            let svg = document.getElementById('svg');
            svg.innerHTML = '';
            let dy = db => 250 - ((db + 60) * (250 / 60));
            let dx = db => ((db + 60) * (300 / 60));

            [-50,-40,-30,-20,-10,0].forEach(db => {
                svg.innerHTML += `<line x1="0" y1="${dy(db)}" x2="300" y2="${dy(db)}" stroke="#374151" stroke-dasharray="2,2"/>`;
                svg.innerHTML += `<line x1="${dx(db)}" y1="0" x2="${dx(db)}" y2="300" stroke="#374151" stroke-dasharray="2,2"/>`;
            });
            svg.innerHTML += `<line x1="0" y1="250" x2="300" y2="0" stroke="#4b5563" stroke-width="2" stroke-dasharray="4,4"/>`;
            svg.innerHTML += `<line x1="${dx(s.threshold)}" y1="0" x2="${dx(s.threshold)}" y2="300" stroke="#ef4444" stroke-width="2" stroke-dasharray="4,2"/>`;

            let path = '';
            for (let db = -60; db <= 0; db++) {
                let out = calcOutput(db);
                path += (db === -60 ? 'M' : 'L') + ` ${dx(db)} ${dy(out)} `;
            }
            svg.innerHTML += `<path d="${path}" fill="none" stroke="#3b82f6" stroke-width="3"/>`;

            if (s.playing) {
                // Calculate the instant output for curve position (purple dot on curve)
                let instantOut = calcOutput(s.input);
                svg.innerHTML += `<circle cx="${dx(s.input)}" cy="${dy(s.input)}" r="6" fill="#22c55e" stroke="#fff" stroke-width="2"/>`;
                svg.innerHTML += `<circle cx="${dx(s.input)}" cy="${dy(instantOut)}" r="6" fill="#a855f7" stroke="#fff" stroke-width="2"/>`;
                svg.innerHTML += `<line x1="${dx(s.input)}" y1="${dy(s.input)}" x2="${dx(s.input)}" y2="${dy(instantOut)}" stroke="#fbbf24" stroke-width="2" stroke-dasharray="2,2"/>`;
            }
            svg.innerHTML += `<text x="10" y="20" fill="#9ca3af" font-size="12">Output (dB)</text>`;
            svg.innerHTML += `<text x="230" y="290" fill="#9ca3af" font-size="12">Input (dB)</text>`;
        }

        function animate() {
            if (!s.playing) return;
            s.time += 0.05;
            let target = genSignal(s.time);
            let outTarget = calcOutput(target);
            let outBefore = outTarget - s.makeupGain;
            let grTarget = target > s.threshold ? Math.max(0, target - outBefore) : 0;
            let ac = 1 - Math.exp(-1 / (s.attack * 0.06));
            let rc = 1 - Math.exp(-1 / (s.release * 0.06));
            s.input = target;
            let od = outTarget - s.output;
            if (Math.abs(od) > 0.01) s.output += od * (od < 0 ? ac : rc); else s.output = outTarget;
            let gd = grTarget - s.gr;
            if (Math.abs(gd) > 0.01) s.gr += gd * (gd > 0 ? ac : rc); else s.gr = grTarget;
            updateMeters();
            draw();
            s.frame = requestAnimationFrame(animate);
        }

        document.getElementById('playBtn').onclick = () => {
            s.playing = !s.playing;
            let btn = document.getElementById('playBtn');
            if (s.playing) {
                btn.textContent = '⏸ Stop';
                btn.className = 'px-4 py-2 rounded font-semibold bg-red-600 hover:bg-red-500';
                document.getElementById('prompt').style.display = 'none';
                animate();
            } else {
                btn.textContent = '▶ Play';
                btn.className = 'px-4 py-2 rounded font-semibold bg-green-600 hover:bg-green-500';
                if (s.frame) cancelAnimationFrame(s.frame);
            }
        };

        document.getElementById('threshold').oninput = e => { s.threshold = +e.target.value; document.getElementById('threshVal').textContent = s.threshold + ' dB'; draw(); };
        document.getElementById('ratio').oninput = e => { s.ratio = +e.target.value; document.getElementById('ratioVal').textContent = s.ratio + ':1'; draw(); };
        document.getElementById('attack').oninput = e => { s.attack = +e.target.value; document.getElementById('attackVal').textContent = s.attack + ' ms'; };
        document.getElementById('release').oninput = e => { s.release = +e.target.value; document.getElementById('releaseVal').textContent = s.release + ' ms'; };
        document.getElementById('knee').oninput = e => { s.knee = +e.target.value; document.getElementById('kneeVal').textContent = s.knee === 0 ? 'Hard' : s.knee < 3 ? 'Medium' : 'Soft'; draw(); };
        document.getElementById('makeupGain').oninput = e => { s.makeupGain = +e.target.value; document.getElementById('makeupVal').textContent = '+' + s.makeupGain + ' dB'; draw(); };

        function preset(p) {
            let presets = {
                reset: [-20,4,10,100,3,0], vocal: [-20,3,15,150,4,0], bass: [-25,5,30,300,3,0],
                snare: [-15,4,10,150,3,0], mixbus: [-8,2,30,400,5,0]
            };
            let v = presets[p];
            s.threshold = v[0]; s.ratio = v[1]; s.attack = v[2]; s.release = v[3]; s.knee = v[4]; s.makeupGain = v[5];
            document.getElementById('threshold').value = v[0]; document.getElementById('threshVal').textContent = v[0] + ' dB';
            document.getElementById('ratio').value = v[1]; document.getElementById('ratioVal').textContent = v[1] + ':1';
            document.getElementById('attack').value = v[2]; document.getElementById('attackVal').textContent = v[2] + ' ms';
            document.getElementById('release').value = v[3]; document.getElementById('releaseVal').textContent = v[3] + ' ms';
            document.getElementById('knee').value = v[4]; document.getElementById('kneeVal').textContent = v[4] === 0 ? 'Hard' : v[4] < 3 ? 'Medium' : 'Soft';
            document.getElementById('makeupGain').value = v[5]; document.getElementById('makeupVal').textContent = '+' + v[5] + ' dB';
            draw();
        }

        draw();
        updateMeters();
    </script>
</body>
</html>
